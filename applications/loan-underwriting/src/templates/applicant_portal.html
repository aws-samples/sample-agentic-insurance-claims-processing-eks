{% extends "base.html" %}

{% block title %}Applicant Portal - Loan Application{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üìù Loan Application</h2>
    <p style="color: #666; margin-bottom: 2rem;">Complete the form below to submit your loan application. Our AI-powered system will process your application in 2-3 minutes.</p>

    <div id="alert-container"></div>

    <form id="applicationForm">
        <!-- Personal Information -->
        <h3 style="margin-bottom: 1rem; color: #667eea;">Personal Information</h3>
        <div class="grid grid-2">
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" name="borrower_first_name" required>
            </div>
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" name="borrower_last_name" required>
            </div>
            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="borrower_email" required>
            </div>
            <div class="form-group">
                <label>Phone *</label>
                <input type="tel" name="borrower_phone" required>
            </div>
            <div class="form-group">
                <label>Date of Birth *</label>
                <input type="date" name="date_of_birth" required>
            </div>
            <div class="form-group">
                <label>SSN (Last 4 Digits) *</label>
                <input type="text" name="ssn_last_4" maxlength="4" pattern="\d{4}" required>
            </div>
        </div>

        <!-- Address -->
        <h3 style="margin: 2rem 0 1rem; color: #667eea;">Current Address</h3>
        <div class="grid grid-2">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Street Address *</label>
                <input type="text" name="street" required>
            </div>
            <div class="form-group">
                <label>City *</label>
                <input type="text" name="city" required>
            </div>
            <div class="form-group">
                <label>State *</label>
                <select name="state" required>
                    <option value="">Select State</option>
                    <option value="CA">California</option>
                    <option value="NY">New York</option>
                    <option value="TX">Texas</option>
                    <option value="FL">Florida</option>
                    <option value="WA">Washington</option>
                    <!-- Add more states as needed -->
                </select>
            </div>
            <div class="form-group">
                <label>ZIP Code *</label>
                <input type="text" name="zip_code" pattern="\d{5}" required>
            </div>
            <div class="form-group">
                <label>Residence Type *</label>
                <select name="residence_type" required>
                    <option value="own">Own</option>
                    <option value="rent">Rent</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Years at Address *</label>
                <input type="number" name="years_at_address" step="0.1" min="0" required>
            </div>
        </div>

        <!-- Employment -->
        <h3 style="margin: 2rem 0 1rem; color: #667eea;">Employment Information</h3>
        <div class="grid grid-2">
            <div class="form-group">
                <label>Employer Name *</label>
                <input type="text" name="employer_name" required>
            </div>
            <div class="form-group">
                <label>Job Title *</label>
                <input type="text" name="job_title" required>
            </div>
            <div class="form-group">
                <label>Employment Type *</label>
                <select name="employment_type" required>
                    <option value="full_time">Full Time</option>
                    <option value="part_time">Part Time</option>
                    <option value="self_employed">Self Employed</option>
                    <option value="contract">Contract</option>
                    <option value="retired">Retired</option>
                </select>
            </div>
            <div class="form-group">
                <label>Years Employed *</label>
                <input type="number" name="years_employed" step="0.1" min="0" required>
            </div>
        </div>

        <!-- Financial Information -->
        <h3 style="margin: 2rem 0 1rem; color: #667eea;">Financial Information</h3>
        <div class="grid grid-2">
            <div class="form-group">
                <label>Annual Income *</label>
                <input type="number" name="annual_income" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Monthly Income *</label>
                <input type="number" name="monthly_income" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Other Income (monthly)</label>
                <input type="number" name="other_income" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
                <label>Monthly Debt Payments *</label>
                <input type="number" name="monthly_debts" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label>Credit Score (if known)</label>
                <input type="number" name="credit_score" min="300" max="850">
            </div>
        </div>

        <!-- Loan Details -->
        <h3 style="margin: 2rem 0 1rem; color: #667eea;">Loan Details</h3>
        <div class="grid grid-2">
            <div class="form-group">
                <label>Loan Type *</label>
                <select name="loan_type" required>
                    <option value="">Select Loan Type</option>
                    {% for loan_type in loan_types %}
                    <option value="{{ loan_type }}">{{ loan_type.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Requested Amount *</label>
                <input type="number" name="requested_amount" step="0.01" min="1000" required>
            </div>
            <div class="form-group">
                <label>Loan Term (months) *</label>
                <select name="loan_term_months" required>
                    <option value="12">12 months</option>
                    <option value="24">24 months</option>
                    <option value="36">36 months</option>
                    <option value="48">48 months</option>
                    <option value="60">60 months</option>
                    <option value="120">120 months</option>
                    <option value="180">180 months</option>
                    <option value="240">240 months</option>
                    <option value="360">360 months</option>
                </select>
            </div>
            <div class="form-group">
                <label>Down Payment</label>
                <input type="number" name="down_payment" step="0.01" min="0" value="0">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Loan Purpose *</label>
                <textarea name="loan_purpose" rows="3" required placeholder="Please describe the purpose of this loan..."></textarea>
            </div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                Submit Application
            </button>
        </div>
    </form>
</div>

<!-- Application Status Modal -->
<div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; margin: 2rem;">
        <h2 style="margin-bottom: 1rem;">Application Status</h2>
        <div id="statusContent"></div>
        <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('applicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const formData = new FormData(e.target);
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    // Convert numeric fields
    const numericFields = ['years_at_address', 'years_employed', 'annual_income', 'monthly_income',
                          'other_income', 'monthly_debts', 'requested_amount', 'down_payment',
                          'loan_term_months'];
    numericFields.forEach(field => {
        if (data[field]) data[field] = parseFloat(data[field]);
    });

    if (data.credit_score) data.credit_score = parseInt(data.credit_score);

    try {
        const response = await fetch('/api/applications/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showStatus(result.application_id);
            e.target.reset();
        } else {
            showAlert('Error submitting application: ' + (result.detail || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
    }
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;

    const container = document.getElementById('alert-container');
    container.innerHTML = '';
    container.appendChild(alertDiv);

    setTimeout(() => alertDiv.remove(), 5000);
}

async function showStatus(applicationId) {
    const modal = document.getElementById('statusModal');
    const content = document.getElementById('statusContent');

    modal.style.display = 'flex';
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing your application...</p></div>';

    // Poll for status
    let attempts = 0;
    const maxAttempts = 60; // 5 minutes

    const checkStatus = async () => {
        try {
            const response = await fetch(`/api/applications/${applicationId}`);
            const app = await response.json();

            if (app.status !== 'submitted' && app.status !== 'underwriting') {
                // Processing complete
                displayDecision(app);
            } else if (attempts < maxAttempts) {
                attempts++;
                setTimeout(checkStatus, 5000); // Check every 5 seconds
            } else {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Application ID:</strong> ${applicationId}<br>
                        Your application is still processing. Please check back later.
                    </div>
                `;
            }
        } catch (error) {
            content.innerHTML = `
                <div class="alert alert-error">
                    Error checking status: ${error.message}
                </div>
            `;
        }
    };

    checkStatus();
}

function displayDecision(app) {
    const content = document.getElementById('statusContent');
    const decision = app.underwriting_decision || {};

    let statusBadge = '';
    let statusClass = '';

    if (decision.decision === 'approved') {
        statusBadge = '<span class="badge badge-success">APPROVED</span>';
        statusClass = 'alert-success';
    } else if (decision.decision === 'conditionally_approved') {
        statusBadge = '<span class="badge badge-warning">CONDITIONALLY APPROVED</span>';
        statusClass = 'alert-info';
    } else {
        statusBadge = '<span class="badge badge-danger">DENIED</span>';
        statusClass = 'alert-error';
    }

    let html = `
        <div class="alert ${statusClass}">
            <h3 style="margin-bottom: 1rem;">${statusBadge}</h3>
            <p><strong>Application ID:</strong> ${app.application_id}</p>
            ${decision.approved_amount ? `<p><strong>Approved Amount:</strong> $${decision.approved_amount.toLocaleString()}</p>` : ''}
            ${decision.interest_rate ? `<p><strong>Interest Rate:</strong> ${decision.interest_rate}%</p>` : ''}
            ${decision.monthly_payment ? `<p><strong>Monthly Payment:</strong> $${decision.monthly_payment.toLocaleString()}</p>` : ''}
        </div>

        ${decision.decision_explanation ? `
            <div style="margin-top: 1rem;">
                <h4>Explanation:</h4>
                <p>${decision.decision_explanation}</p>
            </div>
        ` : ''}

        ${decision.conditions && decision.conditions.length > 0 ? `
            <div style="margin-top: 1rem;">
                <h4>Conditions:</h4>
                <ul>
                    ${decision.conditions.map(c => `<li>${c}</li>`).join('')}
                </ul>
            </div>
        ` : ''}

        ${decision.denial_reasons && decision.denial_reasons.length > 0 ? `
            <div style="margin-top: 1rem;">
                <h4>Denial Reasons:</h4>
                <ul>
                    ${decision.denial_reasons.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </div>
        ` : ''}
    `;

    content.innerHTML = html;
}

function closeModal() {
    document.getElementById('statusModal').style.display = 'none';
}
</script>
{% endblock %}
