{% extends "base.html" %}

{% block title %}Executive Portal{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üìà Executive Dashboard</h2>
    <p style="color: #666; margin-bottom: 2rem;">Business KPIs, financial metrics, and strategic insights for loan underwriting operations.</p>

    <div style="margin-bottom: 1rem;">
        <button class="btn btn-primary" onclick="loadKPIs()">Refresh</button>
    </div>

    <div id="kpis-container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading KPIs...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadKPIs();
});

async function loadKPIs() {
    const container = document.getElementById('kpis-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading KPIs...</p></div>';

    try {
        const response = await fetch('/api/executive/kpis');
        const data = await response.json();

        displayKPIs(data);
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">Error loading KPIs: ${error.message}</div>`;
    }
}

function displayKPIs(data) {
    const container = document.getElementById('kpis-container');

    // Primary KPIs
    const primaryKPIs = `
        <div class="grid grid-4" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <h3>${data.total_applications || 0}</h3>
                <p>Total Applications</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3>${data.approval_rate ? data.approval_rate.toFixed(1) : 0}%</h3>
                <p>Approval Rate</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <h3>${data.avg_processing_time_minutes ? data.avg_processing_time_minutes.toFixed(1) : 0} min</h3>
                <p>Avg Processing Time</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3>${data.ai_accuracy ? data.ai_accuracy.toFixed(1) : 0}%</h3>
                <p>AI Accuracy</p>
            </div>
        </div>
    `;

    // Financial Metrics
    const financialMetrics = `
        <div class="card" style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">üí∞ Financial Performance</h3>
            <div class="grid grid-3">
                <div style="text-align: center; padding: 1.5rem; background: #f0fdf4; border-radius: 8px;">
                    <h2 style="color: #10b981; margin-bottom: 0.5rem;">
                        $${((data.total_loan_amount || 0) / 1000000).toFixed(2)}M
                    </h2>
                    <p style="color: #666;">Total Loan Portfolio</p>
                </div>
                <div style="text-align: center; padding: 1.5rem; background: #eff6ff; border-radius: 8px;">
                    <h2 style="color: #3b82f6; margin-bottom: 0.5rem;">
                        $${(data.avg_loan_amount || 0).toLocaleString()}
                    </h2>
                    <p style="color: #666;">Avg Loan Amount</p>
                </div>
                <div style="text-align: center; padding: 1.5rem; background: #fef3c7; border-radius: 8px;">
                    <h2 style="color: #f59e0b; margin-bottom: 0.5rem;">
                        ${data.avg_interest_rate ? data.avg_interest_rate.toFixed(2) : 0}%
                    </h2>
                    <p style="color: #666;">Avg Interest Rate</p>
                </div>
            </div>
        </div>
    `;

    // Operational Metrics
    const operationalMetrics = `
        <div class="grid grid-2" style="margin-bottom: 2rem;">
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">‚ö° Operational Efficiency</h3>
                <table>
                    <tr>
                        <td><strong>Total Applications:</strong></td>
                        <td>${data.total_applications || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Approved:</strong></td>
                        <td>${data.approved_applications || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Denied:</strong></td>
                        <td>${data.denied_applications || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Avg Processing Time:</strong></td>
                        <td>${data.avg_processing_time_minutes ? data.avg_processing_time_minutes.toFixed(1) : 0} minutes</td>
                    </tr>
                    <tr>
                        <td><strong>AI Decisions:</strong></td>
                        <td>${data.ai_decisions || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Human Overrides:</strong></td>
                        <td>${data.human_overrides || 0}</td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">üéØ Quality Metrics</h3>
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>AI Accuracy</span>
                        <strong>${data.ai_accuracy ? data.ai_accuracy.toFixed(1) : 0}%</strong>
                    </div>
                    <div style="background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #10b981; height: 100%; width: ${data.ai_accuracy || 0}%;"></div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Approval Rate</span>
                        <strong>${data.approval_rate ? data.approval_rate.toFixed(1) : 0}%</strong>
                    </div>
                    <div style="background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #667eea; height: 100%; width: ${data.approval_rate || 0}%;"></div>
                    </div>
                </div>

                <div style="padding: 1rem; background: #f9fafb; border-radius: 6px; margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; color: #667eea;">Performance Summary</h4>
                    ${getPerformanceSummary(data)}
                </div>
            </div>
        </div>
    `;

    // Strategic Insights
    const strategicInsights = `
        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">üí° Strategic Insights</h3>
            <div class="grid grid-3">
                <div style="padding: 1rem; background: #f0fdf4; border-radius: 6px;">
                    <h4 style="color: #10b981; margin-bottom: 0.5rem;">Strengths</h4>
                    ${getStrengths(data)}
                </div>
                <div style="padding: 1rem; background: #fef3c7; border-radius: 6px;">
                    <h4 style="color: #f59e0b; margin-bottom: 0.5rem;">Opportunities</h4>
                    ${getOpportunities(data)}
                </div>
                <div style="padding: 1rem; background: #eff6ff; border-radius: 6px;">
                    <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">Actions</h4>
                    ${getActions(data)}
                </div>
            </div>
        </div>
    `;

    container.innerHTML = primaryKPIs + financialMetrics + operationalMetrics + strategicInsights;
}

function getPerformanceSummary(data) {
    let summary = [];

    if (data.ai_accuracy && data.ai_accuracy >= 90) {
        summary.push('<p style="color: #10b981; margin-bottom: 0.5rem;">‚úì Excellent AI performance</p>');
    } else if (data.ai_accuracy && data.ai_accuracy >= 80) {
        summary.push('<p style="color: #f59e0b; margin-bottom: 0.5rem;">‚ö†Ô∏è AI accuracy needs improvement</p>');
    }

    if (data.avg_processing_time_minutes && data.avg_processing_time_minutes <= 3) {
        summary.push('<p style="color: #10b981; margin-bottom: 0.5rem;">‚úì Fast processing times</p>');
    }

    if (data.approval_rate >= 60 && data.approval_rate <= 75) {
        summary.push('<p style="color: #10b981; margin-bottom: 0.5rem;">‚úì Healthy approval rate</p>');
    }

    return summary.length > 0 ? summary.join('') : '<p>Processing data...</p>';
}

function getStrengths(data) {
    let strengths = [];

    if (data.ai_accuracy && data.ai_accuracy >= 90) {
        strengths.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ High AI accuracy</p>');
    }

    if (data.avg_processing_time_minutes && data.avg_processing_time_minutes <= 3) {
        strengths.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Fast processing</p>');
    }

    if (data.total_loan_amount && data.total_loan_amount > 1000000) {
        strengths.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Strong portfolio</p>');
    }

    return strengths.length > 0 ? strengths.join('') : '<p>Building track record</p>';
}

function getOpportunities(data) {
    let opportunities = [];

    if (data.approval_rate && data.approval_rate < 60) {
        opportunities.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Increase approval rate</p>');
    }

    if (data.human_overrides && data.ai_decisions &&
        (data.human_overrides / data.ai_decisions * 100) > 10) {
        opportunities.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Reduce manual reviews</p>');
    }

    opportunities.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Expand product offerings</p>');
    opportunities.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Market new segments</p>');

    return opportunities.join('');
}

function getActions(data) {
    let actions = [];

    actions.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Review denial patterns</p>');
    actions.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Monitor AI performance</p>');
    actions.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Analyze risk metrics</p>');

    if (data.human_overrides && data.human_overrides > 0) {
        actions.push('<p style="margin-bottom: 0.5rem;">‚Ä¢ Retrain AI models</p>');
    }

    return actions.join('');
}
</script>
{% endblock %}
