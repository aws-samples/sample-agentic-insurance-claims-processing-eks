{% extends "base.html" %}

{% block title %}Loan Officer Portal{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">ðŸ‘” Loan Officer Portal</h2>
    <p style="color: #666; margin-bottom: 2rem;">Review AI underwriting decisions and manage applications requiring human oversight.</p>

    <div id="alert-container"></div>

    <div class="grid grid-3" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <h3 id="pending-count">-</h3>
            <p>Pending Review</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <h3 id="approved-today">-</h3>
            <p>Approved Today</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <h3 id="override-rate">-</h3>
            <p>Override Rate</p>
        </div>
    </div>

    <div style="margin-bottom: 1rem;">
        <button class="btn btn-primary" onclick="loadApplications()">Refresh</button>
    </div>

    <div id="applications-container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading applications...</p>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="padding: 2rem;">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>Application Review</h2>
                <button class="btn btn-danger" onclick="closeReviewModal()">Close</button>
            </div>
            <div id="reviewContent"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentApplication = null;

// Load applications on page load
document.addEventListener('DOMContentLoaded', () => {
    loadApplications();
});

async function loadApplications() {
    const container = document.getElementById('applications-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading applications...</p></div>';

    try {
        const response = await fetch('/api/officer/pending');
        const data = await response.json();

        document.getElementById('pending-count').textContent = data.count || 0;

        if (data.applications && data.applications.length > 0) {
            displayApplications(data.applications);
        } else {
            container.innerHTML = '<div class="alert alert-info">No applications pending review.</div>';
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-error">Error loading applications: ${error.message}</div>`;
    }
}

function displayApplications(applications) {
    const container = document.getElementById('applications-container');

    const table = `
        <table>
            <thead>
                <tr>
                    <th>Application ID</th>
                    <th>Applicant</th>
                    <th>Loan Type</th>
                    <th>Amount</th>
                    <th>AI Decision</th>
                    <th>Risk Level</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${applications.map(app => `
                    <tr>
                        <td>${app.application_id}</td>
                        <td>${app.borrower_first_name} ${app.borrower_last_name}</td>
                        <td>${app.loan_details.loan_type}</td>
                        <td>$${app.loan_details.requested_amount.toLocaleString()}</td>
                        <td>${getDecisionBadge(app.underwriting_decision)}</td>
                        <td>${getRiskBadge(app.risk_assessment)}</td>
                        <td>${new Date(app.submitted_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick='reviewApplication(${JSON.stringify(app).replace(/'/g, "\\'")})'
                                    style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                Review
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    container.innerHTML = table;
}

function getDecisionBadge(decision) {
    if (!decision || !decision.decision) return '<span class="badge badge-info">Processing</span>';

    switch (decision.decision) {
        case 'approved':
            return '<span class="badge badge-success">Approved</span>';
        case 'conditionally_approved':
            return '<span class="badge badge-warning">Conditional</span>';
        case 'denied':
            return '<span class="badge badge-danger">Denied</span>';
        default:
            return '<span class="badge badge-info">Pending</span>';
    }
}

function getRiskBadge(risk) {
    if (!risk || !risk.overall_risk_level) return '<span class="badge badge-info">N/A</span>';

    switch (risk.overall_risk_level) {
        case 'low':
            return '<span class="badge badge-success">Low</span>';
        case 'medium':
            return '<span class="badge badge-warning">Medium</span>';
        case 'high':
            return '<span class="badge badge-danger">High</span>';
        case 'very_high':
            return '<span class="badge badge-danger">Very High</span>';
        default:
            return '<span class="badge badge-info">N/A</span>';
    }
}

function reviewApplication(app) {
    currentApplication = app;
    const modal = document.getElementById('reviewModal');
    const content = document.getElementById('reviewContent');

    const decision = app.underwriting_decision || {};
    const credit = app.credit_analysis || {};
    const income = app.income_verification || {};
    const risk = app.risk_assessment || {};
    const compliance = app.compliance_check || {};

    const html = `
        <!-- Applicant Info -->
        <div class="card" style="background: #f9fafb; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem;">Applicant Information</h3>
            <div class="grid grid-3">
                <div>
                    <strong>Name:</strong> ${app.borrower_first_name} ${app.borrower_last_name}<br>
                    <strong>Email:</strong> ${app.borrower_email}<br>
                    <strong>Phone:</strong> ${app.borrower_phone}
                </div>
                <div>
                    <strong>Employment:</strong> ${app.employment.employer_name}<br>
                    <strong>Job Title:</strong> ${app.employment.job_title}<br>
                    <strong>Years Employed:</strong> ${app.employment.years_employed}
                </div>
                <div>
                    <strong>Monthly Income:</strong> $${app.financial_info.monthly_income.toLocaleString()}<br>
                    <strong>Monthly Debts:</strong> $${app.financial_info.monthly_debts.toLocaleString()}<br>
                    <strong>Credit Score:</strong> ${app.financial_info.credit_score || 'N/A'}
                </div>
            </div>
        </div>

        <!-- Loan Details -->
        <div class="card" style="background: #f9fafb; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem;">Loan Details</h3>
            <div class="grid grid-2">
                <div>
                    <strong>Type:</strong> ${app.loan_details.loan_type}<br>
                    <strong>Amount:</strong> $${app.loan_details.requested_amount.toLocaleString()}<br>
                    <strong>Term:</strong> ${app.loan_details.loan_term_months} months
                </div>
                <div>
                    <strong>Purpose:</strong><br>
                    ${app.loan_details.purpose}
                </div>
            </div>
        </div>

        <!-- AI Analysis -->
        <div class="grid grid-2" style="margin-bottom: 1.5rem;">
            <!-- Credit Analysis -->
            <div class="card" style="background: #eff6ff;">
                <h4 style="margin-bottom: 0.5rem;">Credit Analysis</h4>
                ${credit.credit_risk_level ? `<p><strong>Risk Level:</strong> ${getRiskBadge({overall_risk_level: credit.credit_risk_level})}</p>` : ''}
                ${credit.payment_history_score ? `<p><strong>Payment History:</strong> ${credit.payment_history_score}/100</p>` : ''}
                ${credit.recommendation ? `<p><strong>Recommendation:</strong> ${credit.recommendation}</p>` : ''}
                ${credit.analysis_summary ? `<p style="margin-top: 0.5rem; font-size: 0.875rem;">${credit.analysis_summary}</p>` : ''}
            </div>

            <!-- Income Verification -->
            <div class="card" style="background: #f0fdf4;">
                <h4 style="margin-bottom: 0.5rem;">Income Verification</h4>
                ${income.verified_monthly_income ? `<p><strong>Verified Income:</strong> $${income.verified_monthly_income.toLocaleString()}/mo</p>` : ''}
                ${income.employment_verified !== undefined ? `<p><strong>Employment:</strong> ${income.employment_verified ? 'âœ“ Verified' : 'âœ— Not Verified'}</p>` : ''}
                ${income.income_stability_score ? `<p><strong>Stability Score:</strong> ${income.income_stability_score}/100</p>` : ''}
                ${income.recommendation ? `<p><strong>Recommendation:</strong> ${income.recommendation}</p>` : ''}
            </div>

            <!-- Risk Assessment -->
            <div class="card" style="background: #fef3c7;">
                <h4 style="margin-bottom: 0.5rem;">Risk Assessment</h4>
                ${risk.overall_risk_level ? `<p><strong>Overall Risk:</strong> ${getRiskBadge(risk)}</p>` : ''}
                ${risk.probability_of_default ? `<p><strong>Default Probability:</strong> ${risk.probability_of_default.toFixed(1)}%</p>` : ''}
                ${risk.risk_score ? `<p><strong>Risk Score:</strong> ${risk.risk_score}/100</p>` : ''}
                ${risk.recommendation ? `<p><strong>Recommendation:</strong> ${risk.recommendation}</p>` : ''}
            </div>

            <!-- Compliance -->
            <div class="card" style="background: #fce7f3;">
                <h4 style="margin-bottom: 0.5rem;">Compliance Check</h4>
                ${compliance.compliant !== undefined ? `<p><strong>Status:</strong> ${compliance.compliant ? 'âœ“ Compliant' : 'âœ— Non-Compliant'}</p>` : ''}
                ${compliance.fair_lending_check !== undefined ? `<p><strong>Fair Lending:</strong> ${compliance.fair_lending_check ? 'âœ“ Pass' : 'âœ— Fail'}</p>` : ''}
                ${compliance.ability_to_repay_verified !== undefined ? `<p><strong>Ability to Repay:</strong> ${compliance.ability_to_repay_verified ? 'âœ“ Verified' : 'âœ— Not Verified'}</p>` : ''}
                ${compliance.violations && compliance.violations.length > 0 ? `<p style="color: #dc2626;"><strong>Violations:</strong> ${compliance.violations.length}</p>` : ''}
            </div>
        </div>

        <!-- AI Decision -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem;">AI Underwriting Decision</h3>
            <div style="font-size: 1.5rem; margin-bottom: 1rem;">
                ${getDecisionBadge(decision)}
            </div>
            ${decision.approved_amount ? `<p><strong>Approved Amount:</strong> $${decision.approved_amount.toLocaleString()}</p>` : ''}
            ${decision.interest_rate ? `<p><strong>Interest Rate:</strong> ${decision.interest_rate}%</p>` : ''}
            ${decision.confidence_score ? `<p><strong>AI Confidence:</strong> ${decision.confidence_score}%</p>` : ''}
            ${decision.decision_explanation ? `<p style="margin-top: 1rem; opacity: 0.9;">${decision.decision_explanation}</p>` : ''}
        </div>

        <!-- Officer Override Form -->
        <div class="card">
            <h3 style="margin-bottom: 1rem;">Loan Officer Decision</h3>
            <form id="overrideForm" onsubmit="submitOverride(event)">
                <div class="form-group">
                    <label>Your Decision</label>
                    <select name="override_decision" required>
                        <option value="">Select Decision</option>
                        <option value="approved">Approve</option>
                        <option value="conditionally_approved">Conditionally Approve</option>
                        <option value="denied">Deny</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" name="officer_name" required>
                </div>

                <div class="form-group">
                    <label>Reason / Notes</label>
                    <textarea name="override_reason" rows="4" required placeholder="Explain your decision..."></textarea>
                </div>

                <div class="form-group">
                    <label>Additional Conditions (optional, one per line)</label>
                    <textarea name="conditions" rows="3" placeholder="e.g., Submit updated paystub"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button type="submit" class="btn btn-success">Submit Decision</button>
                    <button type="button" class="btn btn-warning" onclick="closeReviewModal()">Cancel</button>
                </div>
            </form>
        </div>
    `;

    content.innerHTML = html;
    modal.style.display = 'block';
}

async function submitOverride(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const conditions = formData.get('conditions').split('\n').filter(c => c.trim());

    const data = {
        application_id: currentApplication.application_id,
        override_decision: formData.get('override_decision'),
        override_reason: formData.get('override_reason'),
        officer_name: formData.get('officer_name'),
        conditions: conditions
    };

    try {
        const response = await fetch('/api/officer/override', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showAlert('Decision submitted successfully!', 'success');
            closeReviewModal();
            loadApplications();
        } else {
            showAlert('Error: ' + (result.detail || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Network error: ' + error.message, 'error');
    }
}

function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
    currentApplication = null;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;

    const container = document.getElementById('alert-container');
    container.innerHTML = '';
    container.appendChild(alertDiv);

    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}
