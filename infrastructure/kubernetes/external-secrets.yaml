---
# External Secrets Operator Configuration for AWS Secrets Manager
# This file sets up the integration between Kubernetes and AWS Secrets Manager
# for secure credential management

###############################################################
# Namespace for External Secrets Operator
###############################################################
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    name: external-secrets
---
###############################################################
# SecretStore for AWS Secrets Manager
###############################################################
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: insurance-claims
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
###############################################################
# ExternalSecret for MongoDB Credentials
###############################################################
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mongodb-credentials
  namespace: insurance-claims
  labels:
    app: mongodb
    tier: database
spec:
  refreshInterval: 1h  # Refresh secret every hour
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: mongodb-secret-external
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: mongodb
      data:
        # MongoDB connection string
        MONGODB_URL: "mongodb://{{ .username }}:{{ .password }}@mongodb-service.insurance-claims.svc.cluster.local:{{ .port }}/{{ .database }}?authSource=admin"
        # Individual components for flexibility
        MONGO_INITDB_ROOT_USERNAME: "{{ .username }}"
        MONGO_INITDB_ROOT_PASSWORD: "{{ .password }}"
        MONGO_INITDB_DATABASE: "{{ .database }}"
        MONGODB_PORT: "{{ .port }}"
  dataFrom:
    - extract:
        key: agentic-eks-cluster-mongodb-credentials-encrypted
---
###############################################################
# ClusterSecretStore for Cluster-Wide Access (Optional)
###############################################################
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-global
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
###############################################################
# ExternalSecret for LangGraph Secrets
###############################################################
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: langgraph-secrets
  namespace: insurance-claims
  labels:
    app: langgraph
    tier: backend
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: langgraph-secret-external
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app: langgraph
      data:
        REDIS_PASSWORD: "{{ .redis_password }}"
        API_KEY: "{{ .api_key }}"
        ENCRYPTION_KEY: "{{ .encryption_key }}"
  dataFrom:
    - extract:
        key: agentic-eks-cluster-langgraph-secrets
